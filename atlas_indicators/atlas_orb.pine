//@version=6
indicator(
     title              = "ORB [Atlasfutures]",
     overlay            = true,
     max_lines_count    = 500,
     max_boxes_count    = 500,
     max_labels_count   = 500
)

// ============================================================================
// INPUTS - Display
// ============================================================================
drawbackDays = input.int(5, "Days Back", minval=1, maxval=50, tooltip="Number of trading days to show drawings for", group="Display")

// ============================================================================
// INPUTS - Session Toggles
// ============================================================================
enableNY   = input.bool(true, "Enable NY Session", group="Sessions")
enableAsia = input.bool(true, "Enable Asia Session", group="Sessions")

// ============================================================================
// INPUTS - NY Session
// ============================================================================
nySessionRTH   = input.session("0930-1600", "NY RTH (ny time)", group="NY Session")
nyOrbSession   = input.session("0930-0945", "NY ORB window (ny time)", group="NY Session")
nyEntryWindow  = input.session("0945-1300", "NY Entry window (ny time)", group="NY Session")
nyOrbHighColor = input.color(#18b79c, "NY ORB High Color", group="NY Session")
nyOrbLowColor  = input.color(#94E3DA, "NY ORB Low Color", group="NY Session")
nyMaxGapPoints = input.float(100.0, "NY Max Gap (points)", step=1.0, tooltip="Maximum gap size in points (0 = no limit)", group="NY Session")
nyMinGapAtrPct = input.float(1.75, "NY Min Gap (% ATR)", step=0.25, tooltip="Minimum gap size as percentage of daily ATR", group="NY Session")

// ============================================================================
// INPUTS - Asia Session
// ============================================================================
asiaSessionRTH   = input.session("1800-0700", "Asia RTH (ny time)", group="Asia Session")
asiaOrbSession   = input.session("2000-2015", "Asia ORB window (ny time)", group="Asia Session")
asiaEntryWindow  = input.session("2015-2315", "Asia Entry window (ny time)", group="Asia Session")
asiaOrbHighColor = input.color(#2196F3, "Asia ORB High Color", group="Asia Session")
asiaOrbLowColor  = input.color(#A5DFFA, "Asia ORB Low Color", group="Asia Session")
asiaMaxGapPoints = input.float(50.0, "Asia Max Gap (points)", step=1.0, tooltip="Maximum gap size in points (0 = no limit)", group="Asia Session")
asiaMinGapAtrPct = input.float(0.25, "Asia Min Gap (% ATR)", step=0.25, tooltip="Minimum gap size as percentage of daily ATR", group="Asia Session")

// ============================================================================
// INPUTS - Trade Levels
// ============================================================================
rr       = input.float(2.5, "Reward/Risk", step=0.25, group="Trade Levels")
tp1Ratio = input.float(0.5, "TP1/BE Level (fraction of R:R)", step=0.1, minval=0.1, maxval=0.9, group="Trade Levels")
entryColor = input.color(#787b86, "Entry Color", inline="entry", group="Trade Levels")
entryStyle = input.string("Dashed", "Style", options=["Solid", "Dashed", "Dotted"], inline="entry", group="Trade Levels")
slColor    = input.color(#787b86, "SL Color", inline="sl", group="Trade Levels")
slStyle    = input.string("Dashed", "Style", options=["Solid", "Dashed", "Dotted"], inline="sl", group="Trade Levels")
tp1Color   = input.color(#787b86, "TP1 Color", inline="tp1", group="Trade Levels")
tp1Style   = input.string("Dashed", "Style", options=["Solid", "Dashed", "Dotted"], inline="tp1", group="Trade Levels")
tp2Color   = input.color(#787b86, "TP2 Color", inline="tp2", group="Trade Levels")
tp2Style   = input.string("Dashed", "Style", options=["Solid", "Dashed", "Dotted"], inline="tp2", group="Trade Levels")

// ============================================================================
// INPUTS - Daily ATR
// ============================================================================
atrLength = input.int(14, "ATR Length", minval=1, group="Daily ATR")

// ============================================================================
// LINE STYLE LOOKUP
// ============================================================================
styleToLine(s) =>
    s == "Solid" ? line.style_solid : s == "Dotted" ? line.style_dotted : line.style_dashed
entryLineStyle = styleToLine(entryStyle)
slLineStyle    = styleToLine(slStyle)
tp1LineStyle   = styleToLine(tp1Style)
tp2LineStyle   = styleToLine(tp2Style)

// ============================================================================
// SAFETY: intended for intraday charts (1h and under)
// ============================================================================
is5m = timeframe.isintraday and timeframe.in_seconds() <= 3600
barClosed = barstate.isconfirmed

// ============================================================================
// SESSION FILTERS - NY
// ============================================================================
inNyRTH      = not na(time(timeframe.period, nySessionRTH, "America/New_York"))
inNyORB      = not na(time(timeframe.period, nyOrbSession, "America/New_York"))
inNyEntryWin = not na(time(timeframe.period, nyEntryWindow, "America/New_York"))

// ============================================================================
// SESSION FILTERS - Asia
// ============================================================================
inAsiaRTH      = not na(time(timeframe.period, asiaSessionRTH, "America/New_York"))
inAsiaORB      = not na(time(timeframe.period, asiaOrbSession, "America/New_York"))
inAsiaEntryWin = not na(time(timeframe.period, asiaEntryWindow, "America/New_York"))

// New trading day
newDay = ta.change(time("D")) != 0

// ============================================================================
// DRAWBACK FILTER - only draw recent N days
// ============================================================================
barsPerDay = timeframe.in_seconds("D") / timeframe.in_seconds(timeframe.period)
canDraw    = bar_index >= last_bar_index - drawbackDays * barsPerDay

// ============================================================================
// NY ORB STATE
// ============================================================================
var float ny_orbHigh = na
var float ny_orbLow  = na
var bool  ny_orbReady = false

var bool  ny_longFirstFvgFound  = false
var bool  ny_shortFirstFvgFound = false

var float ny_longFvgTopStored  = na
var float ny_longFvgBotStored  = na
var int   ny_longFvgStartBar   = na
var string ny_longFvgText      = na

var float ny_shortFvgTopStored = na
var float ny_shortFvgBotStored = na
var int   ny_shortFvgStartBar  = na
var string ny_shortFvgText     = na

// ============================================================================
// ASIA ORB STATE
// ============================================================================
var float asia_orbHigh = na
var float asia_orbLow  = na
var bool  asia_orbReady = false

var bool  asia_longFirstFvgFound  = false
var bool  asia_shortFirstFvgFound = false

var float asia_longFvgTopStored  = na
var float asia_longFvgBotStored  = na
var int   asia_longFvgStartBar   = na
var string asia_longFvgText      = na

var float asia_shortFvgTopStored = na
var float asia_shortFvgBotStored = na
var int   asia_shortFvgStartBar  = na
var string asia_shortFvgText     = na

// ============================================================================
// DRAWING REFERENCES (draw once, update to extend)
// ============================================================================
// NY ORB lines
var line ny_orbHighLine = na
var line ny_orbLowLine  = na
var int  ny_orbLineStart = na

// Asia ORB lines
var line asia_orbHighLine = na
var line asia_orbLowLine  = na
var int  asia_orbLineStart = na

// FVG boxes + labels (draw once, extend right edge)
var box   ny_longFvgBox      = na
var box   ny_shortFvgBox     = na
var box   asia_longFvgBox    = na
var box   asia_shortFvgBox   = na
var label ny_longFvgLabel    = na
var label ny_shortFvgLabel   = na
var label asia_longFvgLabel  = na
var label asia_shortFvgLabel = na

// Track whether ORB lines have been created this session
var bool ny_orbLinesDrawn   = false
var bool asia_orbLinesDrawn = false

// ============================================================================
// TRADE LEVEL STATE - NY
// ============================================================================
var float ny_longEntry = na
var float ny_longStop  = na
var float ny_longTp1   = na
var float ny_longTp2   = na

var float ny_shortEntry = na
var float ny_shortStop  = na
var float ny_shortTp1   = na
var float ny_shortTp2   = na

// ============================================================================
// TRADE LEVEL STATE - Asia
// ============================================================================
var float asia_longEntry = na
var float asia_longStop  = na
var float asia_longTp1   = na
var float asia_longTp2   = na

var float asia_shortEntry = na
var float asia_shortStop  = na
var float asia_shortTp1   = na
var float asia_shortTp2   = na

// ============================================================================
// TRADE LEVEL LINE/LABEL REFS
// ============================================================================
var line ny_longEntryLine = na
var line ny_longStopLine  = na
var line ny_longTp1Line   = na
var line ny_longTp2Line   = na
var label ny_longStopLbl  = na
var label ny_longTp1Lbl   = na
var label ny_longTp2Lbl   = na

var line ny_shortEntryLine = na
var line ny_shortStopLine  = na
var line ny_shortTp1Line   = na
var line ny_shortTp2Line   = na
var label ny_shortStopLbl  = na
var label ny_shortTp1Lbl   = na
var label ny_shortTp2Lbl   = na

var line asia_longEntryLine = na
var line asia_longStopLine  = na
var line asia_longTp1Line   = na
var line asia_longTp2Line   = na
var label asia_longStopLbl  = na
var label asia_longTp1Lbl   = na
var label asia_longTp2Lbl   = na

var line asia_shortEntryLine = na
var line asia_shortStopLine  = na
var line asia_shortTp1Line   = na
var line asia_shortTp2Line   = na
var label asia_shortStopLbl  = na
var label asia_shortTp1Lbl   = na
var label asia_shortTp2Lbl   = na

// ============================================================================
// RESET ON NEW DAY
// ============================================================================
if newDay
    ny_orbHigh := na
    ny_orbLow  := na
    ny_orbReady := false
    ny_longFirstFvgFound := false
    ny_shortFirstFvgFound := false
    ny_longFvgTopStored := na
    ny_longFvgBotStored := na
    ny_longFvgStartBar  := na
    ny_longFvgText      := na
    ny_shortFvgTopStored := na
    ny_shortFvgBotStored := na
    ny_shortFvgStartBar  := na
    ny_shortFvgText      := na
    ny_orbLinesDrawn := false
    ny_orbHighLine := na
    ny_orbLowLine  := na
    ny_orbLineStart := na

    ny_longEntry := na
    ny_longStop  := na
    ny_longTp1   := na
    ny_longTp2   := na
    ny_shortEntry := na
    ny_shortStop  := na
    ny_shortTp1   := na
    ny_shortTp2   := na
    ny_longEntryLine := na
    ny_longStopLine  := na
    ny_longTp1Line   := na
    ny_longTp2Line   := na
    ny_longStopLbl   := na
    ny_longTp1Lbl    := na
    ny_longTp2Lbl    := na
    ny_shortEntryLine := na
    ny_shortStopLine  := na
    ny_shortTp1Line   := na
    ny_shortTp2Line   := na
    ny_shortStopLbl   := na
    ny_shortTp1Lbl    := na
    ny_shortTp2Lbl    := na

    asia_orbHigh := na
    asia_orbLow  := na
    asia_orbReady := false
    asia_longFirstFvgFound := false
    asia_shortFirstFvgFound := false
    asia_longFvgTopStored := na
    asia_longFvgBotStored := na
    asia_longFvgStartBar  := na
    asia_longFvgText      := na
    asia_shortFvgTopStored := na
    asia_shortFvgBotStored := na
    asia_shortFvgStartBar  := na
    asia_shortFvgText      := na
    asia_orbLinesDrawn := false
    asia_orbHighLine := na
    asia_orbLowLine  := na
    asia_orbLineStart := na

    asia_longEntry := na
    asia_longStop  := na
    asia_longTp1   := na
    asia_longTp2   := na
    asia_shortEntry := na
    asia_shortStop  := na
    asia_shortTp1   := na
    asia_shortTp2   := na
    asia_longEntryLine := na
    asia_longStopLine  := na
    asia_longTp1Line   := na
    asia_longTp2Line   := na
    asia_longStopLbl   := na
    asia_longTp1Lbl    := na
    asia_longTp2Lbl    := na
    asia_shortEntryLine := na
    asia_shortStopLine  := na
    asia_shortTp1Line   := na
    asia_shortTp2Line   := na
    asia_shortStopLbl   := na
    asia_shortTp1Lbl    := na
    asia_shortTp2Lbl    := na

    // Clear FVG drawing refs so they don't get extended into the new day
    ny_longFvgBox      := na
    ny_shortFvgBox     := na
    asia_longFvgBox    := na
    asia_shortFvgBox   := na
    ny_longFvgLabel    := na
    ny_shortFvgLabel   := na
    asia_longFvgLabel  := na
    asia_shortFvgLabel := na

// ============================================================================
// BUILD ORB - NY
// ============================================================================
if enableNY and inNyORB and inNyRTH and is5m
    ny_orbHigh := na(ny_orbHigh) ? high : math.max(ny_orbHigh, high)
    ny_orbLow  := na(ny_orbLow)  ? low  : math.min(ny_orbLow, low)

if enableNY and not inNyORB and inNyRTH and is5m and not ny_orbReady and not na(ny_orbHigh) and not na(ny_orbLow)
    ny_orbReady := true

// ============================================================================
// BUILD ORB - Asia
// ============================================================================
if enableAsia and inAsiaORB and inAsiaRTH and is5m
    asia_orbHigh := na(asia_orbHigh) ? high : math.max(asia_orbHigh, high)
    asia_orbLow  := na(asia_orbLow)  ? low  : math.min(asia_orbLow, low)

if enableAsia and not inAsiaORB and inAsiaRTH and is5m and not asia_orbReady and not na(asia_orbHigh) and not na(asia_orbLow)
    asia_orbReady := true

// ============================================================================
// DAILY ATR + GLOBEX OPEN
// ============================================================================
dailyATR = request.security(syminfo.tickerid, "D", ta.atr(atrLength)[1], lookahead=barmerge.lookahead_on)
extTicker  = ticker.new(syminfo.prefix, syminfo.ticker, session.extended)
globexOpen = request.security(extTicker, "D", open, lookahead=barmerge.lookahead_on)

// ============================================================================
// FVG SIZE REQUIREMENTS
// ============================================================================
nyMinGap   = (nyMinGapAtrPct / 100) * nz(dailyATR)
asiaMinGap = (asiaMinGapAtrPct / 100) * nz(dailyATR)
nyMaxGap   = nyMaxGapPoints > 0 ? nyMaxGapPoints : float(na)
asiaMaxGap = asiaMaxGapPoints > 0 ? asiaMaxGapPoints : float(na)

// ============================================================================
// FVG DETECTION
// ============================================================================
longFvgTop     = low
longFvgBottom  = high[2]
shortFvgTop    = low[2]
shortFvgBottom = high
longGapSize    = longFvgTop - longFvgBottom
shortGapSize   = shortFvgTop - shortFvgBottom

// NY FVG validation
nyLongGapValid  = longGapSize >= nyMinGap and (na(nyMaxGap) or longGapSize <= nyMaxGap)
nyShortGapValid = shortGapSize >= nyMinGap and (na(nyMaxGap) or shortGapSize <= nyMaxGap)
nyLongFVG  = high[2] < low and high[2] < high[1] and low[2] < low and longFvgTop > ny_orbHigh and nyLongGapValid
nyShortFVG = low[2] > high and low[2] > low[1] and high[2] > high and shortFvgBottom < ny_orbLow and nyShortGapValid

// Asia FVG validation
asiaLongGapValid  = longGapSize >= asiaMinGap and (na(asiaMaxGap) or longGapSize <= asiaMaxGap)
asiaShortGapValid = shortGapSize >= asiaMinGap and (na(asiaMaxGap) or shortGapSize <= asiaMaxGap)
asiaLongFVG  = high[2] < low and high[2] < high[1] and low[2] < low and longFvgTop > asia_orbHigh and asiaLongGapValid
asiaShortFVG = low[2] > high and low[2] > low[1] and high[2] > high and shortFvgBottom < asia_orbLow and asiaShortGapValid

// ============================================================================
// DETECT FIRST FVG - NY
// ============================================================================
nyCanDetect = enableNY and is5m and barClosed and inNyRTH and inNyEntryWin and ny_orbReady

if nyCanDetect and not ny_longFirstFvgFound and nyLongFVG
    ny_longFirstFvgFound := true
    ny_longFvgTopStored  := longFvgTop
    ny_longFvgBotStored  := longFvgBottom
    ny_longFvgStartBar   := bar_index - 2
    fvgPts    = longGapSize
    fvgAtrPct = dailyATR > 0 ? (fvgPts / dailyATR) * 100 : 0.0
    ny_longFvgText := str.tostring(fvgPts, format.mintick) + " pts (" + str.tostring(fvgAtrPct, "#.0") + "% ATR)"
    // Draw box + label + trade levels ONCE (only within drawback window)
    ny_longEntry := longFvgTop
    ny_longStop  := math.min(low[2], longFvgTop - syminfo.mintick)
    riskPts      = ny_longEntry - ny_longStop
    ny_longTp1   := ny_longEntry + (rr * riskPts * tp1Ratio)
    ny_longTp2   := ny_longEntry + (rr * riskPts)
    if canDraw
        ny_longFvgBox := box.new(ny_longFvgStartBar, ny_longFvgTopStored, bar_index, ny_longFvgBotStored, border_color=color.new(color.white, 100), bgcolor=color.new(#787b86, 80), border_width=0)
        ny_longFvgLabel := label.new(bar_index, (ny_longFvgTopStored + ny_longFvgBotStored) / 2, ny_longFvgText, style=label.style_label_left, color=color.new(color.white, 100), textcolor=color.new(#787b86, 0), size=size.small)
        slPts  = riskPts
        slAtr  = dailyATR > 0 ? (slPts / dailyATR) * 100 : 0.0
        tp1Pts = ny_longTp1 - ny_longEntry
        tp1Atr = dailyATR > 0 ? (tp1Pts / dailyATR) * 100 : 0.0
        tp2Pts = ny_longTp2 - ny_longEntry
        tp2Atr = dailyATR > 0 ? (tp2Pts / dailyATR) * 100 : 0.0
        ny_longEntryLine := line.new(bar_index, ny_longEntry, bar_index, ny_longEntry, color=entryColor, style=entryLineStyle, width=1)
        ny_longStopLine  := line.new(bar_index, ny_longStop, bar_index, ny_longStop, color=slColor, style=slLineStyle, width=1)
        ny_longTp1Line   := line.new(bar_index, ny_longTp1, bar_index, ny_longTp1, color=tp1Color, style=tp1LineStyle, width=1)
        ny_longTp2Line   := line.new(bar_index, ny_longTp2, bar_index, ny_longTp2, color=tp2Color, style=tp2LineStyle, width=1)
        slTxt  = "SL: " + str.tostring(slPts, format.mintick) + " (" + str.tostring(slAtr, "#.0") + "% ATR)"
        tp1Txt = "TP1: " + str.tostring(tp1Pts, format.mintick) + " (" + str.tostring(tp1Atr, "#.0") + "% ATR)"
        tp2Txt = "TP2: " + str.tostring(tp2Pts, format.mintick) + " (" + str.tostring(tp2Atr, "#.0") + "% ATR)"
        ny_longStopLbl := label.new(bar_index, ny_longStop, slTxt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=slColor, size=size.small)
        ny_longTp1Lbl  := label.new(bar_index, ny_longTp1, tp1Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp1Color, size=size.small)
        ny_longTp2Lbl  := label.new(bar_index, ny_longTp2, tp2Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp2Color, size=size.small)

if nyCanDetect and not ny_shortFirstFvgFound and nyShortFVG
    ny_shortFirstFvgFound := true
    ny_shortFvgTopStored  := shortFvgTop
    ny_shortFvgBotStored  := shortFvgBottom
    ny_shortFvgStartBar   := bar_index - 2
    fvgPts    = shortGapSize
    fvgAtrPct = dailyATR > 0 ? (fvgPts / dailyATR) * 100 : 0.0
    ny_shortFvgText := str.tostring(fvgPts, format.mintick) + " pts (" + str.tostring(fvgAtrPct, "#.0") + "% ATR)"
    ny_shortEntry := shortFvgBottom
    ny_shortStop  := math.max(high[2], shortFvgBottom + syminfo.mintick)
    riskPts       = ny_shortStop - ny_shortEntry
    ny_shortTp1   := ny_shortEntry - (rr * riskPts * tp1Ratio)
    ny_shortTp2   := ny_shortEntry - (rr * riskPts)
    if canDraw
        ny_shortFvgBox := box.new(ny_shortFvgStartBar, ny_shortFvgTopStored, bar_index, ny_shortFvgBotStored, border_color=color.new(color.white, 100), bgcolor=color.new(#787b86, 80), border_width=0)
        ny_shortFvgLabel := label.new(bar_index, (ny_shortFvgTopStored + ny_shortFvgBotStored) / 2, ny_shortFvgText, style=label.style_label_left, color=color.new(color.white, 100), textcolor=color.new(#787b86, 0), size=size.small)
        slPts  = riskPts
        slAtr  = dailyATR > 0 ? (slPts / dailyATR) * 100 : 0.0
        tp1Pts = ny_shortEntry - ny_shortTp1
        tp1Atr = dailyATR > 0 ? (tp1Pts / dailyATR) * 100 : 0.0
        tp2Pts = ny_shortEntry - ny_shortTp2
        tp2Atr = dailyATR > 0 ? (tp2Pts / dailyATR) * 100 : 0.0
        ny_shortEntryLine := line.new(bar_index, ny_shortEntry, bar_index, ny_shortEntry, color=entryColor, style=entryLineStyle, width=1)
        ny_shortStopLine  := line.new(bar_index, ny_shortStop, bar_index, ny_shortStop, color=slColor, style=slLineStyle, width=1)
        ny_shortTp1Line   := line.new(bar_index, ny_shortTp1, bar_index, ny_shortTp1, color=tp1Color, style=tp1LineStyle, width=1)
        ny_shortTp2Line   := line.new(bar_index, ny_shortTp2, bar_index, ny_shortTp2, color=tp2Color, style=tp2LineStyle, width=1)
        slTxt  = "SL: " + str.tostring(slPts, format.mintick) + " (" + str.tostring(slAtr, "#.0") + "% ATR)"
        tp1Txt = "TP1: " + str.tostring(tp1Pts, format.mintick) + " (" + str.tostring(tp1Atr, "#.0") + "% ATR)"
        tp2Txt = "TP2: " + str.tostring(tp2Pts, format.mintick) + " (" + str.tostring(tp2Atr, "#.0") + "% ATR)"
        ny_shortStopLbl := label.new(bar_index, ny_shortStop, slTxt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=slColor, size=size.small)
        ny_shortTp1Lbl  := label.new(bar_index, ny_shortTp1, tp1Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp1Color, size=size.small)
        ny_shortTp2Lbl  := label.new(bar_index, ny_shortTp2, tp2Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp2Color, size=size.small)

// ============================================================================
// DETECT FIRST FVG - Asia
// ============================================================================
asiaCanDetect = enableAsia and is5m and barClosed and inAsiaRTH and inAsiaEntryWin and asia_orbReady

if asiaCanDetect and not asia_longFirstFvgFound and asiaLongFVG
    asia_longFirstFvgFound := true
    asia_longFvgTopStored  := longFvgTop
    asia_longFvgBotStored  := longFvgBottom
    asia_longFvgStartBar   := bar_index - 2
    fvgPts    = longGapSize
    fvgAtrPct = dailyATR > 0 ? (fvgPts / dailyATR) * 100 : 0.0
    asia_longFvgText := str.tostring(fvgPts, format.mintick) + " pts (" + str.tostring(fvgAtrPct, "#.0") + "% ATR)"
    asia_longEntry := longFvgTop
    asia_longStop  := math.min(low[2], longFvgTop - syminfo.mintick)
    riskPts        = asia_longEntry - asia_longStop
    asia_longTp1   := asia_longEntry + (rr * riskPts * tp1Ratio)
    asia_longTp2   := asia_longEntry + (rr * riskPts)
    if canDraw
        asia_longFvgBox := box.new(asia_longFvgStartBar, asia_longFvgTopStored, bar_index, asia_longFvgBotStored, border_color=color.new(color.white, 100), bgcolor=color.new(#787b86, 80), border_width=0)
        asia_longFvgLabel := label.new(bar_index, (asia_longFvgTopStored + asia_longFvgBotStored) / 2, asia_longFvgText, style=label.style_label_left, color=color.new(color.white, 100), textcolor=color.new(#787b86, 0), size=size.small)
        slPts  = riskPts
        slAtr  = dailyATR > 0 ? (slPts / dailyATR) * 100 : 0.0
        tp1Pts = asia_longTp1 - asia_longEntry
        tp1Atr = dailyATR > 0 ? (tp1Pts / dailyATR) * 100 : 0.0
        tp2Pts = asia_longTp2 - asia_longEntry
        tp2Atr = dailyATR > 0 ? (tp2Pts / dailyATR) * 100 : 0.0
        asia_longEntryLine := line.new(bar_index, asia_longEntry, bar_index, asia_longEntry, color=entryColor, style=entryLineStyle, width=1)
        asia_longStopLine  := line.new(bar_index, asia_longStop, bar_index, asia_longStop, color=slColor, style=slLineStyle, width=1)
        asia_longTp1Line   := line.new(bar_index, asia_longTp1, bar_index, asia_longTp1, color=tp1Color, style=tp1LineStyle, width=1)
        asia_longTp2Line   := line.new(bar_index, asia_longTp2, bar_index, asia_longTp2, color=tp2Color, style=tp2LineStyle, width=1)
        slTxt  = "SL: " + str.tostring(slPts, format.mintick) + " (" + str.tostring(slAtr, "#.0") + "% ATR)"
        tp1Txt = "TP1: " + str.tostring(tp1Pts, format.mintick) + " (" + str.tostring(tp1Atr, "#.0") + "% ATR)"
        tp2Txt = "TP2: " + str.tostring(tp2Pts, format.mintick) + " (" + str.tostring(tp2Atr, "#.0") + "% ATR)"
        asia_longStopLbl := label.new(bar_index, asia_longStop, slTxt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=slColor, size=size.small)
        asia_longTp1Lbl  := label.new(bar_index, asia_longTp1, tp1Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp1Color, size=size.small)
        asia_longTp2Lbl  := label.new(bar_index, asia_longTp2, tp2Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp2Color, size=size.small)

if asiaCanDetect and not asia_shortFirstFvgFound and asiaShortFVG
    asia_shortFirstFvgFound := true
    asia_shortFvgTopStored  := shortFvgTop
    asia_shortFvgBotStored  := shortFvgBottom
    asia_shortFvgStartBar   := bar_index - 2
    fvgPts    = shortGapSize
    fvgAtrPct = dailyATR > 0 ? (fvgPts / dailyATR) * 100 : 0.0
    asia_shortFvgText := str.tostring(fvgPts, format.mintick) + " pts (" + str.tostring(fvgAtrPct, "#.0") + "% ATR)"
    asia_shortEntry := shortFvgBottom
    asia_shortStop  := math.max(high[2], shortFvgBottom + syminfo.mintick)
    riskPts         = asia_shortStop - asia_shortEntry
    asia_shortTp1   := asia_shortEntry - (rr * riskPts * tp1Ratio)
    asia_shortTp2   := asia_shortEntry - (rr * riskPts)
    if canDraw
        asia_shortFvgBox := box.new(asia_shortFvgStartBar, asia_shortFvgTopStored, bar_index, asia_shortFvgBotStored, border_color=color.new(color.white, 100), bgcolor=color.new(#787b86, 80), border_width=0)
        asia_shortFvgLabel := label.new(bar_index, (asia_shortFvgTopStored + asia_shortFvgBotStored) / 2, asia_shortFvgText, style=label.style_label_left, color=color.new(color.white, 100), textcolor=color.new(#787b86, 0), size=size.small)
        slPts  = riskPts
        slAtr  = dailyATR > 0 ? (slPts / dailyATR) * 100 : 0.0
        tp1Pts = asia_shortEntry - asia_shortTp1
        tp1Atr = dailyATR > 0 ? (tp1Pts / dailyATR) * 100 : 0.0
        tp2Pts = asia_shortEntry - asia_shortTp2
        tp2Atr = dailyATR > 0 ? (tp2Pts / dailyATR) * 100 : 0.0
        asia_shortEntryLine := line.new(bar_index, asia_shortEntry, bar_index, asia_shortEntry, color=entryColor, style=entryLineStyle, width=1)
        asia_shortStopLine  := line.new(bar_index, asia_shortStop, bar_index, asia_shortStop, color=slColor, style=slLineStyle, width=1)
        asia_shortTp1Line   := line.new(bar_index, asia_shortTp1, bar_index, asia_shortTp1, color=tp1Color, style=tp1LineStyle, width=1)
        asia_shortTp2Line   := line.new(bar_index, asia_shortTp2, bar_index, asia_shortTp2, color=tp2Color, style=tp2LineStyle, width=1)
        slTxt  = "SL: " + str.tostring(slPts, format.mintick) + " (" + str.tostring(slAtr, "#.0") + "% ATR)"
        tp1Txt = "TP1: " + str.tostring(tp1Pts, format.mintick) + " (" + str.tostring(tp1Atr, "#.0") + "% ATR)"
        tp2Txt = "TP2: " + str.tostring(tp2Pts, format.mintick) + " (" + str.tostring(tp2Atr, "#.0") + "% ATR)"
        asia_shortStopLbl := label.new(bar_index, asia_shortStop, slTxt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=slColor, size=size.small)
        asia_shortTp1Lbl  := label.new(bar_index, asia_shortTp1, tp1Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp1Color, size=size.small)
        asia_shortTp2Lbl  := label.new(bar_index, asia_shortTp2, tp2Txt, style=label.style_label_left, color=color.new(color.white, 100), textcolor=tp2Color, size=size.small)

// ============================================================================
// EXTEND FVG BOXES + LABELS (update right edge, not delete+redraw)
// ============================================================================
if enableNY and inNyRTH and inNyEntryWin and not na(ny_longFvgBox)
    box.set_right(ny_longFvgBox, bar_index)
    label.set_x(ny_longFvgLabel, bar_index)

if enableNY and inNyRTH and inNyEntryWin and not na(ny_shortFvgBox)
    box.set_right(ny_shortFvgBox, bar_index)
    label.set_x(ny_shortFvgLabel, bar_index)

if enableAsia and inAsiaRTH and inAsiaEntryWin and not na(asia_longFvgBox)
    box.set_right(asia_longFvgBox, bar_index)
    label.set_x(asia_longFvgLabel, bar_index)

if enableAsia and inAsiaRTH and inAsiaEntryWin and not na(asia_shortFvgBox)
    box.set_right(asia_shortFvgBox, bar_index)
    label.set_x(asia_shortFvgLabel, bar_index)

// ============================================================================
// EXTEND TRADE LEVEL LINES + LABELS
// ============================================================================
if enableNY and inNyRTH and inNyEntryWin and not na(ny_longEntryLine)
    line.set_x2(ny_longEntryLine, bar_index)
    line.set_x2(ny_longStopLine, bar_index)
    line.set_x2(ny_longTp1Line, bar_index)
    line.set_x2(ny_longTp2Line, bar_index)
    label.set_x(ny_longStopLbl, bar_index)
    label.set_x(ny_longTp1Lbl, bar_index)
    label.set_x(ny_longTp2Lbl, bar_index)

if enableNY and inNyRTH and inNyEntryWin and not na(ny_shortEntryLine)
    line.set_x2(ny_shortEntryLine, bar_index)
    line.set_x2(ny_shortStopLine, bar_index)
    line.set_x2(ny_shortTp1Line, bar_index)
    line.set_x2(ny_shortTp2Line, bar_index)
    label.set_x(ny_shortStopLbl, bar_index)
    label.set_x(ny_shortTp1Lbl, bar_index)
    label.set_x(ny_shortTp2Lbl, bar_index)

if enableAsia and inAsiaRTH and inAsiaEntryWin and not na(asia_longEntryLine)
    line.set_x2(asia_longEntryLine, bar_index)
    line.set_x2(asia_longStopLine, bar_index)
    line.set_x2(asia_longTp1Line, bar_index)
    line.set_x2(asia_longTp2Line, bar_index)
    label.set_x(asia_longStopLbl, bar_index)
    label.set_x(asia_longTp1Lbl, bar_index)
    label.set_x(asia_longTp2Lbl, bar_index)

if enableAsia and inAsiaRTH and inAsiaEntryWin and not na(asia_shortEntryLine)
    line.set_x2(asia_shortEntryLine, bar_index)
    line.set_x2(asia_shortStopLine, bar_index)
    line.set_x2(asia_shortTp1Line, bar_index)
    line.set_x2(asia_shortTp2Line, bar_index)
    label.set_x(asia_shortStopLbl, bar_index)
    label.set_x(asia_shortTp1Lbl, bar_index)
    label.set_x(asia_shortTp2Lbl, bar_index)

// ============================================================================
// VISUALS - ORB LINES (draw once per session, extend right edge)
// ============================================================================
// NY: create lines once when ORB is ready, then extend each bar during entry window
nyShowOrb = enableNY and inNyRTH and inNyEntryWin and ny_orbReady
if nyShowOrb and not ny_orbLinesDrawn and canDraw
    ny_orbLineStart := bar_index
    ny_orbHighLine := line.new(ny_orbLineStart, ny_orbHigh, bar_index, ny_orbHigh, color=nyOrbHighColor, width=2)
    ny_orbLowLine  := line.new(ny_orbLineStart, ny_orbLow, bar_index, ny_orbLow, color=nyOrbLowColor, width=2)
    ny_orbLinesDrawn := true

if nyShowOrb and ny_orbLinesDrawn and not na(ny_orbHighLine)
    line.set_x2(ny_orbHighLine, bar_index)
    line.set_x2(ny_orbLowLine, bar_index)

// Asia: create lines once when ORB is ready, then extend each bar during entry window
asiaShowOrb = enableAsia and inAsiaRTH and inAsiaEntryWin and asia_orbReady
if asiaShowOrb and not asia_orbLinesDrawn and canDraw
    asia_orbLineStart := bar_index
    asia_orbHighLine := line.new(asia_orbLineStart, asia_orbHigh, bar_index, asia_orbHigh, color=asiaOrbHighColor, width=2)
    asia_orbLowLine  := line.new(asia_orbLineStart, asia_orbLow, bar_index, asia_orbLow, color=asiaOrbLowColor, width=2)
    asia_orbLinesDrawn := true

if asiaShowOrb and asia_orbLinesDrawn and not na(asia_orbHighLine)
    line.set_x2(asia_orbHighLine, bar_index)
    line.set_x2(asia_orbLowLine, bar_index)

// ============================================================================
// ATR DISTANCE DISPLAY
// ============================================================================
globexDist  = close - globexOpen
globexPct   = dailyATR > 0 ? (globexDist / dailyATR) * 100 : 0.0
globexSign  = globexDist >= 0 ? "+" : ""
globexColor = globexDist >= 0 ? color.new(#26a69a, 0) : color.new(#ef5350, 0)

var table atrTable = table.new(position.top_right, 1, 2, bgcolor=color.new(#1e222d, 10), border_width=1, border_color=color.new(#363a45, 0))
if barstate.islast
    atrText = "ATR(" + str.tostring(atrLength) + "): " + str.tostring(dailyATR, format.mintick)
    globexText = "GlobEx: " + globexSign + str.tostring(globexDist, format.mintick) + " (" + globexSign + str.tostring(globexPct, "#.0") + "% ATR)"
    table.cell(atrTable, 0, 0, atrText, text_color=color.white, text_size=size.small)
    table.cell(atrTable, 0, 1, globexText, text_color=globexColor, text_size=size.small)
