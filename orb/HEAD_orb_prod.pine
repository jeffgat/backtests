//@version=6
strategy(
     title              = "ORB V4 Bot NY/Asia",
     overlay            = true,
     initial_capital    = 100000,
     pyramiding         = 0,
     margin_long        = 0,
     margin_short       = 0,
     commission_type    = strategy.commission.cash_per_contract,
     commission_value   = 0.05,
     process_orders_on_close = true,
     use_bar_magnifier  = true,
     fill_orders_on_standard_ohlc = false
)

// ----------------------------------------------------------------------------------------
// Inputs - Shared Risk Settings
// ----------------------------------------------------------------------------------------
riskUsd      = input.float(1000, "Risk per trade ($)", step=50, group="Risk Settings")
rr           = input.float(2.5, "Reward/Risk", step=0.25, group="Risk Settings")
tp1Ratio     = input.float(0.5, "Partial TP & BE Level (0.5 = 50% of target)", step=0.1, minval=0.1, maxval=0.9, group="Risk Settings")
minQty       = input.float(1.0, "Min Qty", step=0.1, group="Risk Settings")
qtyStep      = input.float(1.0, "Qty Step", step=0.1, group="Risk Settings")
beOffsetTicks = input.int(4, "BE Offset (ticks)", step=1, tooltip="Ticks above entry for BE stop to cover commission", group="Risk Settings")

// ----------------------------------------------------------------------------------------
// Inputs - Asia Session Settings
// ----------------------------------------------------------------------------------------
asiaSessionRTH   = input.session("1800-0700", "Asia RTH (ny time)", group="Asia Session")
asiaOrbSession   = input.session("2000-2015", "Asia ORB window (ny time)", group="Asia Session")
asiaEntryWindow  = input.session("2015-2315", "Asia Entry window (ny time)", group="Asia Session")
asiaFlatWindow   = input.session("0645-0700", "Asia Flat window (ny time)", group="Asia Session")
asiaMinGapPoints = input.float(2.0, "Asia Min Gap (points)", step=1.0, group="Asia Session")
asiaMinGapTicks  = input.int(8, "Asia Min Gap (ticks)", step=5, group="Asia Session")
asiaMaxGapPoints = input.float(50.0, "Asia Max Gap (points)", step=1.0, group="Asia Session")
asiaMaxGapTicks  = input.int(200, "Asia Max Gap (ticks)", step=5, group="Asia Session")

// ----------------------------------------------------------------------------------------
// Inputs - NY Session Settings
// ----------------------------------------------------------------------------------------
nySessionRTH     = input.session("0930-1600", "NY RTH (ny time)", group="NY Session")
nyOrbSession     = input.session("0930-0945", "NY ORB window (ny time)", group="NY Session")
nyEntryWindow    = input.session("0945-1300", "NY Entry window (ny time)", group="NY Session")
nyFlatWindow     = input.session("1550-1600", "NY Flat window (ny time)", group="NY Session")
nyMinGapPoints   = input.float(10.0, "NY Min Gap (points)", step=1.0, group="NY Session")
nyMinGapTicks    = input.int(40, "NY Min Gap (ticks)", step=5, group="NY Session")
nyMaxGapPoints   = input.float(100.0, "NY Max Gap (points)", step=1.0, group="NY Session")
nyMaxGapTicks    = input.int(400, "NY Max Gap (ticks)", step=5, group="NY Session")

// ----------------------------------------------------------------------------------------
// Inputs - NY Half-Day Early Close Dates
// CME equity futures close at 1:00 PM ET on these dates.
// Update this list annually — check CME holiday calendar.
// Reference: 2025 dates from NYSE/CME schedules.
// ----------------------------------------------------------------------------------------
nyHalfDayFlatWindow = input.session("1250-1300", "NY Half-Day Flat window (ny time)", group="NY Half-Day")
// Format: YYYYMMDD — add/remove dates as needed
halfDay1 = input.string("20250703", "Half-Day 1 (YYYYMMDD)", tooltip="Day before July 4th", group="NY Half-Day")
halfDay2 = input.string("20251128", "Half-Day 2 (YYYYMMDD)", tooltip="Day after Thanksgiving", group="NY Half-Day")
halfDay3 = input.string("20251224", "Half-Day 3 (YYYYMMDD)", tooltip="Christmas Eve", group="NY Half-Day")
halfDay4 = input.string("20250109", "Half-Day 4 (YYYYMMDD)", tooltip="National Day of Mourning (one-off)", group="NY Half-Day")
halfDay5 = input.string("20260119", "Half-Day 5 (YYYYMMDD)", tooltip="MLK Day 2026", group="NY Half-Day")
halfDay6 = input.string("", "Half-Day 6 (YYYYMMDD)", tooltip="Leave blank if unused", group="NY Half-Day")

// ----------------------------------------------------------------------------------------
// Safety: intended for 5m charts
// ----------------------------------------------------------------------------------------
is5m = timeframe.isintraday and timeframe.multiplier == 5
barClosed = barstate.isconfirmed

// ----------------------------------------------------------------------------------------
// Session filters - Asia
// ----------------------------------------------------------------------------------------
inAsiaRTH      = not na(time(timeframe.period, asiaSessionRTH, "America/New_York"))
inAsiaORB      = not na(time(timeframe.period, asiaOrbSession, "America/New_York"))
inAsiaEntryWin = not na(time(timeframe.period, asiaEntryWindow, "America/New_York"))
inAsiaFlatWin  = not na(time(timeframe.period, asiaFlatWindow, "America/New_York"))
asiaAfterCutoff = inAsiaRTH and not inAsiaEntryWin

// ----------------------------------------------------------------------------------------
// Session filters - NY
// ----------------------------------------------------------------------------------------
inNyRTH      = not na(time(timeframe.period, nySessionRTH, "America/New_York"))
inNyORB      = not na(time(timeframe.period, nyOrbSession, "America/New_York"))
inNyEntryWin = not na(time(timeframe.period, nyEntryWindow, "America/New_York"))
inNyFlatWin  = not na(time(timeframe.period, nyFlatWindow, "America/New_York"))
inNyHalfDayFlatWin = not na(time(timeframe.period, nyHalfDayFlatWindow, "America/New_York"))
nyAfterCutoff = inNyRTH and not inNyEntryWin

// new trading day
newDay = ta.change(time("D")) != 0

// ----------------------------------------------------------------------------------------
// exclude specific problematic dates
// ----------------------------------------------------------------------------------------
currentMonth = month(time, "America/New_York")
currentDay   = dayofmonth(time, "America/New_York")
currentYear  = year(time, "America/New_York")
isExcludedDate = currentYear == 2024 and currentMonth == 12 and currentDay == 18

// Half-day detection
todayStr = str.format("{0,number,0000}{1,number,00}{2,number,00}", currentYear, currentMonth, currentDay)
isNyHalfDay = todayStr == halfDay1 or todayStr == halfDay2 or todayStr == halfDay3 or todayStr == halfDay4 or (halfDay5 != "" and todayStr == halfDay5) or (halfDay6 != "" and todayStr == halfDay6)

// ----------------------------------------------------------------------------------------
// Asia Session State Variables
// ----------------------------------------------------------------------------------------
var float asia_orbHigh  = na
var float asia_orbLow   = na
var bool  asia_orbReady = false
var bool  asia_hasTradedToday = false
var int   asia_closedTradesAtDayStart = 0

var bool  asia_longSetupActive  = false
var bool  asia_shortSetupActive = false
var bool  asia_longFirstFvgFound  = false
var bool  asia_shortFirstFvgFound = false

var float asia_longStopStored   = na
var float asia_longTargetStored = na
var float asia_longHalfwayStored = na
var float asia_longEntryStored  = na
var float asia_longQtyStored    = na
var float asia_longHalfQty      = na
var bool  asia_longBEActive      = false
var bool  asia_longSingleContract = false
var float asia_longFilledEntry  = na

var float asia_shortStopStored   = na
var float asia_shortTargetStored = na
var float asia_shortHalfwayStored = na
var float asia_shortEntryStored  = na
var float asia_shortQtyStored    = na
var float asia_shortHalfQty      = na
var bool  asia_shortBEActive      = false
var bool  asia_shortSingleContract = false
var float asia_shortFilledEntry = na

var int asia_longSetupBar  = na
var int asia_shortSetupBar = na

// ----------------------------------------------------------------------------------------
// NY Session State Variables
// ----------------------------------------------------------------------------------------
var float ny_orbHigh  = na
var float ny_orbLow   = na
var bool  ny_orbReady = false
var bool  ny_hasTradedToday = false
var int   ny_closedTradesAtDayStart = 0

var bool  ny_longSetupActive  = false
var bool  ny_shortSetupActive = false
var bool  ny_longFirstFvgFound  = false
var bool  ny_shortFirstFvgFound = false

var float ny_longStopStored   = na
var float ny_longTargetStored = na
var float ny_longHalfwayStored = na
var float ny_longEntryStored  = na
var float ny_longQtyStored    = na
var float ny_longHalfQty      = na
var bool  ny_longBEActive      = false
var bool  ny_longSingleContract = false
var float ny_longFilledEntry  = na

var float ny_shortStopStored   = na
var float ny_shortTargetStored = na
var float ny_shortHalfwayStored = na
var float ny_shortEntryStored  = na
var float ny_shortQtyStored    = na
var float ny_shortHalfQty      = na
var bool  ny_shortBEActive      = false
var bool  ny_shortSingleContract = false
var float ny_shortFilledEntry = na

var int ny_longSetupBar  = na
var int ny_shortSetupBar = na

// Track which session owns current position
var string activeSession = na

// ----------------------------------------------------------------------------------------
// Reset on new day
// ----------------------------------------------------------------------------------------
if newDay
    // Asia reset
    asia_orbHigh := na
    asia_orbLow  := na
    asia_orbReady := false
    asia_hasTradedToday := false
    asia_closedTradesAtDayStart := strategy.closedtrades

    asia_longSetupActive := false
    asia_shortSetupActive := false
    asia_longFirstFvgFound := false
    asia_shortFirstFvgFound := false
    asia_longStopStored := na
    asia_longTargetStored := na
    asia_longHalfwayStored := na
    asia_longEntryStored := na
    asia_longQtyStored := na
    asia_longHalfQty := na
    asia_longBEActive := false
    asia_longSingleContract := false
    asia_longFilledEntry := na
    asia_shortStopStored := na
    asia_shortTargetStored := na
    asia_shortHalfwayStored := na
    asia_shortEntryStored := na
    asia_shortQtyStored := na
    asia_shortHalfQty := na
    asia_shortBEActive := false
    asia_shortSingleContract := false
    asia_shortFilledEntry := na
    asia_longSetupBar := na
    asia_shortSetupBar := na

    // NY reset
    ny_orbHigh := na
    ny_orbLow  := na
    ny_orbReady := false
    ny_hasTradedToday := false
    ny_closedTradesAtDayStart := strategy.closedtrades

    ny_longSetupActive := false
    ny_shortSetupActive := false
    ny_longFirstFvgFound := false
    ny_shortFirstFvgFound := false
    ny_longStopStored := na
    ny_longTargetStored := na
    ny_longHalfwayStored := na
    ny_longEntryStored := na
    ny_longQtyStored := na
    ny_longHalfQty := na
    ny_longBEActive := false
    ny_longSingleContract := false
    ny_longFilledEntry := na
    ny_shortStopStored := na
    ny_shortTargetStored := na
    ny_shortHalfwayStored := na
    ny_shortEntryStored := na
    ny_shortQtyStored := na
    ny_shortHalfQty := na
    ny_shortBEActive := false
    ny_shortSingleContract := false
    ny_shortFilledEntry := na
    ny_longSetupBar := na
    ny_shortSetupBar := na

    activeSession := na

    strategy.cancel("AL")
    strategy.cancel("AS")
    strategy.cancel("NL")
    strategy.cancel("NS")

// ----------------------------------------------------------------------------------------
// Detect trade occurred for each session
// ----------------------------------------------------------------------------------------
// Asia: track trades during Asia RTH
asiaTradeHappened = ((strategy.opentrades > 0 and activeSession == "asia") or (strategy.closedtrades > asia_closedTradesAtDayStart and activeSession == "asia"))

if asiaTradeHappened and not asia_hasTradedToday
    asia_hasTradedToday := true
    asia_longSetupActive := false
    asia_shortSetupActive := false
    asia_longFirstFvgFound := true
    asia_shortFirstFvgFound := true
    asia_longEntryStored := na
    asia_shortEntryStored := na
    strategy.cancel("AL")
    strategy.cancel("AS")

// NY: track trades during NY RTH
nyTradeHappened = ((strategy.opentrades > 0 and activeSession == "ny") or (strategy.closedtrades > ny_closedTradesAtDayStart and activeSession == "ny"))

if nyTradeHappened and not ny_hasTradedToday
    ny_hasTradedToday := true
    ny_longSetupActive := false
    ny_shortSetupActive := false
    ny_longFirstFvgFound := true
    ny_shortFirstFvgFound := true
    ny_longEntryStored := na
    ny_shortEntryStored := na
    strategy.cancel("NL")
    strategy.cancel("NS")

// ----------------------------------------------------------------------------------------
// Build ORB - Asia (20:00-20:15)
// ----------------------------------------------------------------------------------------
if inAsiaORB and inAsiaRTH and is5m
    asia_orbHigh := na(asia_orbHigh) ? high : math.max(asia_orbHigh, high)
    asia_orbLow  := na(asia_orbLow)  ? low  : math.min(asia_orbLow, low)

if not inAsiaORB and inAsiaRTH and is5m and not asia_orbReady and not na(asia_orbHigh) and not na(asia_orbLow)
    asia_orbReady := true

// ----------------------------------------------------------------------------------------
// Build ORB - NY (09:30-09:45)
// ----------------------------------------------------------------------------------------
if inNyORB and inNyRTH and is5m
    ny_orbHigh := na(ny_orbHigh) ? high : math.max(ny_orbHigh, high)
    ny_orbLow  := na(ny_orbLow)  ? low  : math.min(ny_orbLow, low)

if not inNyORB and inNyRTH and is5m and not ny_orbReady and not na(ny_orbHigh) and not na(ny_orbLow)
    ny_orbReady := true

// ----------------------------------------------------------------------------------------
// FVG size requirements - Asia
// ----------------------------------------------------------------------------------------
asiaMinGap = math.max(asiaMinGapPoints, asiaMinGapTicks * syminfo.mintick)
asiaMaxGapFromPoints = asiaMaxGapPoints > 0 ? asiaMaxGapPoints : na
asiaMaxGapFromTicks  = asiaMaxGapTicks > 0 ? asiaMaxGapTicks * syminfo.mintick : na
asiaMaxGap = not na(asiaMaxGapFromPoints) and not na(asiaMaxGapFromTicks) ? math.min(asiaMaxGapFromPoints, asiaMaxGapFromTicks) : nz(asiaMaxGapFromPoints, nz(asiaMaxGapFromTicks, na))

// ----------------------------------------------------------------------------------------
// FVG size requirements - NY
// ----------------------------------------------------------------------------------------
nyMinGap = math.max(nyMinGapPoints, nyMinGapTicks * syminfo.mintick)
nyMaxGapFromPoints = nyMaxGapPoints > 0 ? nyMaxGapPoints : na
nyMaxGapFromTicks  = nyMaxGapTicks > 0 ? nyMaxGapTicks * syminfo.mintick : na
nyMaxGap = not na(nyMaxGapFromPoints) and not na(nyMaxGapFromTicks) ? math.min(nyMaxGapFromPoints, nyMaxGapFromTicks) : nz(nyMaxGapFromPoints, nz(nyMaxGapFromTicks, na))

// ----------------------------------------------------------------------------------------
// FVG detection (shared calculation, session-specific validation)
// ----------------------------------------------------------------------------------------
longFvgTop    = low
longFvgBottom = high[2]
shortFvgTop   = low[2]
shortFvgBottom = high
longGapSize  = longFvgTop - longFvgBottom
shortGapSize = shortFvgTop - shortFvgBottom

// Asia FVG validation
asiaLongGapValid  = longGapSize >= asiaMinGap and (na(asiaMaxGap) or longGapSize <= asiaMaxGap)
asiaShortGapValid = shortGapSize >= asiaMinGap and (na(asiaMaxGap) or shortGapSize <= asiaMaxGap)
asiaLongFVG  = high[2] < low and high[2] < high[1] and low[2] < low and longFvgTop > asia_orbHigh and asiaLongGapValid
asiaShortFVG = low[2] > high and low[2] > low[1] and high[2] > high and shortFvgBottom < asia_orbLow and asiaShortGapValid

// NY FVG validation
nyLongGapValid  = longGapSize >= nyMinGap and (na(nyMaxGap) or longGapSize <= nyMaxGap)
nyShortGapValid = shortGapSize >= nyMinGap and (na(nyMaxGap) or shortGapSize <= nyMaxGap)
nyLongFVG  = high[2] < low and high[2] < high[1] and low[2] < low and longFvgTop > ny_orbHigh and nyLongGapValid
nyShortFVG = low[2] > high and low[2] > low[1] and high[2] > high and shortFvgBottom < ny_orbLow and nyShortGapValid

// BE offset calculation
beOffset = beOffsetTicks * syminfo.mintick

// ----------------------------------------------------------------------------------------
// qty rounding helpers
// ----------------------------------------------------------------------------------------
floorToStep(x, step) =>
    step <= 0 ? x : math.floor(x / step) * step

// ----------------------------------------------------------------------------------------
// Activate setup - Asia Session
// ----------------------------------------------------------------------------------------
asiaCanArmSetup = (is5m and barClosed and inAsiaRTH and inAsiaEntryWin and asia_orbReady and not asia_hasTradedToday and not isExcludedDate and strategy.position_size == 0 and not (asia_longSetupActive or asia_shortSetupActive))

// Asia long setup arm
if asiaCanArmSetup and not asia_longFirstFvgFound and asiaLongFVG
    rawStop = low[2]
    entry   = longFvgTop
    stop    = math.min(rawStop, entry - syminfo.mintick)
    riskPts = entry - stop

    if riskPts > 0
        qtyRaw = riskUsd / (riskPts * syminfo.pointvalue)
        qty    = floorToStep(qtyRaw, qtyStep)
        isSingleContract = qty <= minQty
        halfQty = isSingleContract ? qty : floorToStep(qty / 2, qtyStep)
        halfQty := math.max(halfQty, minQty)

        if qty >= minQty
            asia_longStopStored   := stop
            asia_longTargetStored := entry + rr * riskPts
            asia_longHalfwayStored := entry + (rr * riskPts * tp1Ratio)
            asia_longEntryStored  := entry
            asia_longQtyStored    := qty
            asia_longHalfQty      := halfQty
            asia_longSingleContract := isSingleContract
            asia_longSetupActive  := true
            asia_longFirstFvgFound := true
            asia_longSetupBar     := bar_index

// Asia short setup arm
if asiaCanArmSetup and not asia_shortFirstFvgFound and asiaShortFVG
    rawStop = high[2]
    entry   = shortFvgBottom
    stop    = math.max(rawStop, entry + syminfo.mintick)
    riskPts = stop - entry

    if riskPts > 0
        qtyRaw = riskUsd / (riskPts * syminfo.pointvalue)
        qty    = floorToStep(qtyRaw, qtyStep)
        isSingleContract = qty <= minQty
        halfQty = isSingleContract ? qty : floorToStep(qty / 2, qtyStep)
        halfQty := math.max(halfQty, minQty)

        if qty >= minQty
            asia_shortStopStored   := stop
            asia_shortTargetStored := entry - rr * riskPts
            asia_shortHalfwayStored := entry - (rr * riskPts * tp1Ratio)
            asia_shortEntryStored  := entry
            asia_shortQtyStored    := qty
            asia_shortHalfQty      := halfQty
            asia_shortSingleContract := isSingleContract
            asia_shortSetupActive  := true
            asia_shortFirstFvgFound := true
            asia_shortSetupBar     := bar_index

// ----------------------------------------------------------------------------------------
// Activate setup - NY Session
// ----------------------------------------------------------------------------------------
nyCanArmSetup = (is5m and barClosed and inNyRTH and inNyEntryWin and ny_orbReady and not ny_hasTradedToday and not isExcludedDate and strategy.position_size == 0 and not (ny_longSetupActive or ny_shortSetupActive))

// NY long setup arm
if nyCanArmSetup and not ny_longFirstFvgFound and nyLongFVG
    rawStop = low[2]
    entry   = longFvgTop
    stop    = math.min(rawStop, entry - syminfo.mintick)
    riskPts = entry - stop

    if riskPts > 0
        qtyRaw = riskUsd / (riskPts * syminfo.pointvalue)
        qty    = floorToStep(qtyRaw, qtyStep)
        isSingleContract = qty <= minQty
        halfQty = isSingleContract ? qty : floorToStep(qty / 2, qtyStep)
        halfQty := math.max(halfQty, minQty)

        if qty >= minQty
            ny_longStopStored   := stop
            ny_longTargetStored := entry + rr * riskPts
            ny_longHalfwayStored := entry + (rr * riskPts * tp1Ratio)
            ny_longEntryStored  := entry
            ny_longQtyStored    := qty
            ny_longHalfQty      := halfQty
            ny_longSingleContract := isSingleContract
            ny_longSetupActive  := true
            ny_longFirstFvgFound := true
            ny_longSetupBar     := bar_index

// NY short setup arm
if nyCanArmSetup and not ny_shortFirstFvgFound and nyShortFVG
    rawStop = high[2]
    entry   = shortFvgBottom
    stop    = math.max(rawStop, entry + syminfo.mintick)
    riskPts = stop - entry

    if riskPts > 0
        qtyRaw = riskUsd / (riskPts * syminfo.pointvalue)
        qty    = floorToStep(qtyRaw, qtyStep)
        isSingleContract = qty <= minQty
        halfQty = isSingleContract ? qty : floorToStep(qty / 2, qtyStep)
        halfQty := math.max(halfQty, minQty)

        if qty >= minQty
            ny_shortStopStored   := stop
            ny_shortTargetStored := entry - rr * riskPts
            ny_shortHalfwayStored := entry - (rr * riskPts * tp1Ratio)
            ny_shortEntryStored  := entry
            ny_shortQtyStored    := qty
            ny_shortHalfQty      := halfQty
            ny_shortSingleContract := isSingleContract
            ny_shortSetupActive  := true
            ny_shortFirstFvgFound := true
            ny_shortSetupBar     := bar_index

// ----------------------------------------------------------------------------------------
// Track actual entry fill price and active session
// ----------------------------------------------------------------------------------------
if strategy.position_size > 0 and na(asia_longFilledEntry) and asia_longSetupActive
    asia_longFilledEntry := strategy.opentrades.entry_price(0)
    activeSession := "asia"
if strategy.position_size < 0 and na(asia_shortFilledEntry) and asia_shortSetupActive
    asia_shortFilledEntry := strategy.opentrades.entry_price(0)
    activeSession := "asia"
if strategy.position_size > 0 and na(ny_longFilledEntry) and ny_longSetupActive
    ny_longFilledEntry := strategy.opentrades.entry_price(0)
    activeSession := "ny"
if strategy.position_size < 0 and na(ny_shortFilledEntry) and ny_shortSetupActive
    ny_shortFilledEntry := strategy.opentrades.entry_price(0)
    activeSession := "ny"

// Reset active session when flat
if strategy.position_size == 0
    activeSession := na

// ----------------------------------------------------------------------------------------
// Update breakeven state - Asia
// ----------------------------------------------------------------------------------------
if strategy.position_size > 0 and activeSession == "asia"
    if asia_longSingleContract
        if not na(asia_longHalfwayStored) and high >= asia_longHalfwayStored
            asia_longBEActive := true
    else
        positionReduced = strategy.position_size < asia_longQtyStored and asia_longQtyStored > 0 and not na(asia_longFilledEntry)
        if positionReduced
            asia_longBEActive := true

if strategy.position_size < 0 and activeSession == "asia"
    if asia_shortSingleContract
        if not na(asia_shortHalfwayStored) and low <= asia_shortHalfwayStored
            asia_shortBEActive := true
    else
        positionReduced = math.abs(strategy.position_size) < asia_shortQtyStored and asia_shortQtyStored > 0 and not na(asia_shortFilledEntry)
        if positionReduced
            asia_shortBEActive := true

// ----------------------------------------------------------------------------------------
// Update breakeven state - NY
// ----------------------------------------------------------------------------------------
if strategy.position_size > 0 and activeSession == "ny"
    if ny_longSingleContract
        if not na(ny_longHalfwayStored) and high >= ny_longHalfwayStored
            ny_longBEActive := true
    else
        positionReduced = strategy.position_size < ny_longQtyStored and ny_longQtyStored > 0 and not na(ny_longFilledEntry)
        if positionReduced
            ny_longBEActive := true

if strategy.position_size < 0 and activeSession == "ny"
    if ny_shortSingleContract
        if not na(ny_shortHalfwayStored) and low <= ny_shortHalfwayStored
            ny_shortBEActive := true
    else
        positionReduced = math.abs(strategy.position_size) < ny_shortQtyStored and ny_shortQtyStored > 0 and not na(ny_shortFilledEntry)
        if positionReduced
            ny_shortBEActive := true

// ----------------------------------------------------------------------------------------
// Entry orders - Asia
// ----------------------------------------------------------------------------------------
if is5m and inAsiaRTH and inAsiaEntryWin and not asia_hasTradedToday and strategy.position_size == 0
    if asia_longSetupActive and bar_index > asia_longSetupBar
        strategy.entry("AL", strategy.long, qty=asia_longQtyStored, limit=asia_longEntryStored)
    if asia_shortSetupActive and bar_index > asia_shortSetupBar
        strategy.entry("AS", strategy.short, qty=asia_shortQtyStored, limit=asia_shortEntryStored)

// ----------------------------------------------------------------------------------------
// Entry orders - NY
// ----------------------------------------------------------------------------------------
if is5m and inNyRTH and inNyEntryWin and not ny_hasTradedToday and strategy.position_size == 0
    if ny_longSetupActive and bar_index > ny_longSetupBar
        strategy.entry("NL", strategy.long, qty=ny_longQtyStored, limit=ny_longEntryStored)
    if ny_shortSetupActive and bar_index > ny_shortSetupBar
        strategy.entry("NS", strategy.short, qty=ny_shortQtyStored, limit=ny_shortEntryStored)

// ----------------------------------------------------------------------------------------
// Exit orders - Asia
// ----------------------------------------------------------------------------------------
if strategy.position_size > 0 and activeSession == "asia"
    beStopPrice = (not na(asia_longFilledEntry) ? asia_longFilledEntry : asia_longEntryStored) + beOffset
    finalStop = asia_longBEActive ? beStopPrice : asia_longStopStored

    if asia_longSingleContract
        strategy.exit("AL-F", from_entry="AL", stop=finalStop, limit=asia_longTargetStored, comment_loss=asia_longBEActive ? "a-l-be" : "a-l-sl", comment_profit="a-l-tp2")
    else
        strategy.exit("AL-P", from_entry="AL", qty=asia_longHalfQty, stop=finalStop, limit=asia_longHalfwayStored, comment_loss=asia_longBEActive ? "a-l-be" : "a-l-sl", comment_profit="a-l-tp1")
        strategy.exit("AL-F", from_entry="AL", stop=finalStop, limit=asia_longTargetStored, comment_loss=asia_longBEActive ? "a-l-be" : "a-l-sl", comment_profit="a-l-tp2")

if strategy.position_size < 0 and activeSession == "asia"
    beStopPrice = (not na(asia_shortFilledEntry) ? asia_shortFilledEntry : asia_shortEntryStored) - beOffset
    finalStop = asia_shortBEActive ? beStopPrice : asia_shortStopStored

    if asia_shortSingleContract
        strategy.exit("AS-F", from_entry="AS", stop=finalStop, limit=asia_shortTargetStored, comment_loss=asia_shortBEActive ? "a-s-be" : "a-s-sl", comment_profit="a-s-tp2")
    else
        strategy.exit("AS-P", from_entry="AS", qty=asia_shortHalfQty, stop=finalStop, limit=asia_shortHalfwayStored, comment_loss=asia_shortBEActive ? "a-s-be" : "a-s-sl", comment_profit="a-s-tp1")
        strategy.exit("AS-F", from_entry="AS", stop=finalStop, limit=asia_shortTargetStored, comment_loss=asia_shortBEActive ? "a-s-be" : "a-s-sl", comment_profit="a-s-tp2")

// ----------------------------------------------------------------------------------------
// Exit orders - NY
// ----------------------------------------------------------------------------------------
if strategy.position_size > 0 and activeSession == "ny"
    beStopPrice = (not na(ny_longFilledEntry) ? ny_longFilledEntry : ny_longEntryStored) + beOffset
    finalStop = ny_longBEActive ? beStopPrice : ny_longStopStored

    if ny_longSingleContract
        strategy.exit("NL-F", from_entry="NL", stop=finalStop, limit=ny_longTargetStored, comment_loss=ny_longBEActive ? "n-l-be" : "n-l-sl", comment_profit="n-l-tp2")
    else
        strategy.exit("NL-P", from_entry="NL", qty=ny_longHalfQty, stop=finalStop, limit=ny_longHalfwayStored, comment_loss=ny_longBEActive ? "n-l-be" : "n-l-sl", comment_profit="n-l-tp1")
        strategy.exit("NL-F", from_entry="NL", stop=finalStop, limit=ny_longTargetStored, comment_loss=ny_longBEActive ? "n-l-be" : "n-l-sl", comment_profit="n-l-tp2")

if strategy.position_size < 0 and activeSession == "ny"
    beStopPrice = (not na(ny_shortFilledEntry) ? ny_shortFilledEntry : ny_shortEntryStored) - beOffset
    finalStop = ny_shortBEActive ? beStopPrice : ny_shortStopStored

    if ny_shortSingleContract
        strategy.exit("NS-F", from_entry="NS", stop=finalStop, limit=ny_shortTargetStored, comment_loss=ny_shortBEActive ? "n-s-be" : "n-s-sl", comment_profit="n-s-tp2")
    else
        strategy.exit("NS-P", from_entry="NS", qty=ny_shortHalfQty, stop=finalStop, limit=ny_shortHalfwayStored, comment_loss=ny_shortBEActive ? "n-s-be" : "n-s-sl", comment_profit="n-s-tp1")
        strategy.exit("NS-F", from_entry="NS", stop=finalStop, limit=ny_shortTargetStored, comment_loss=ny_shortBEActive ? "n-s-be" : "n-s-sl", comment_profit="n-s-tp2")

// ----------------------------------------------------------------------------------------
// Cancel pending orders after cutoff - Asia
// ----------------------------------------------------------------------------------------
if asiaAfterCutoff
    strategy.cancel("AL")
    strategy.cancel("AS")
    asia_longSetupActive := false
    asia_shortSetupActive := false
    asia_longEntryStored := na
    asia_shortEntryStored := na
    asia_longSetupBar := na
    asia_shortSetupBar := na

if not inAsiaRTH
    strategy.cancel("AL")
    strategy.cancel("AS")
    asia_longSetupActive := false
    asia_shortSetupActive := false
    asia_longEntryStored := na
    asia_shortEntryStored := na
    asia_longSetupBar := na
    asia_shortSetupBar := na

// ----------------------------------------------------------------------------------------
// Cancel pending orders after cutoff - NY
// ----------------------------------------------------------------------------------------
if nyAfterCutoff
    strategy.cancel("NL")
    strategy.cancel("NS")
    ny_longSetupActive := false
    ny_shortSetupActive := false
    ny_longEntryStored := na
    ny_shortEntryStored := na
    ny_longSetupBar := na
    ny_shortSetupBar := na

if not inNyRTH
    strategy.cancel("NL")
    strategy.cancel("NS")
    ny_longSetupActive := false
    ny_shortSetupActive := false
    ny_longEntryStored := na
    ny_shortEntryStored := na
    ny_longSetupBar := na
    ny_shortSetupBar := na

// ----------------------------------------------------------------------------------------
// Flat at end of session
// ----------------------------------------------------------------------------------------
if inAsiaFlatWin and strategy.position_size != 0 and activeSession == "asia"
    if strategy.position_size > 0
        strategy.close("AL", comment="asia-eod-flat")
    if strategy.position_size < 0
        strategy.close("AS", comment="asia-eod-flat")

nyFlatNow = isNyHalfDay ? inNyHalfDayFlatWin : inNyFlatWin
if nyFlatNow and strategy.position_size != 0 and activeSession == "ny"
    if strategy.position_size > 0
        strategy.close("NL", comment="ny-eod-flat")
    if strategy.position_size < 0
        strategy.close("NS", comment="ny-eod-flat")

// ----------------------------------------------------------------------------------------
// Hidden Plots for TradersPost Webhooks
// ----------------------------------------------------------------------------------------
// Determine current position's levels based on active session and direction
currentTP1 = strategy.position_size > 0 ? (activeSession == "asia" ? asia_longHalfwayStored : ny_longHalfwayStored) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortHalfwayStored : ny_shortHalfwayStored) : na

currentTP2 = strategy.position_size > 0 ? (activeSession == "asia" ? asia_longTargetStored : ny_longTargetStored) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortTargetStored : ny_shortTargetStored) : na

currentStop = strategy.position_size > 0 ? (activeSession == "asia" ? asia_longStopStored : ny_longStopStored) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortStopStored : ny_shortStopStored) : na

currentBE = strategy.position_size > 0 ? (activeSession == "asia" ? asia_longFilledEntry + beOffset : ny_longFilledEntry + beOffset) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortFilledEntry - beOffset : ny_shortFilledEntry - beOffset) : na

currentEntry = strategy.position_size > 0 ? (activeSession == "asia" ? asia_longEntryStored : ny_longEntryStored) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortEntryStored : ny_shortEntryStored) : na

// Quantity for current setup
currentQty = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longQtyStored : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortQtyStored : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longQtyStored : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortQtyStored : strategy.position_size > 0 ? (activeSession == "asia" ? asia_longQtyStored : ny_longQtyStored) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortQtyStored : ny_shortQtyStored) : na

// Half quantity for partial exits
currentHalfQty = strategy.position_size > 0 ? (activeSession == "asia" ? asia_longHalfQty : ny_longHalfQty) : strategy.position_size < 0 ? (activeSession == "asia" ? asia_shortHalfQty : ny_shortHalfQty) : na

// Entry prices for new setups (needed at alert time, before position opens)
setupEntry = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longEntryStored : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortEntryStored : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longEntryStored : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortEntryStored : na

setupStop = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longStopStored : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortStopStored : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longStopStored : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortStopStored : na

setupTP1 = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longHalfwayStored : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortHalfwayStored : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longHalfwayStored : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortHalfwayStored : na

setupTP2 = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longTargetStored : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortTargetStored : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longTargetStored : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortTargetStored : na

setupHalfQty = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longHalfQty : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortHalfQty : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longHalfQty : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortHalfQty : na

setupSingleContract = (asia_longSetupActive and asia_longSetupActive[1] == false) ? asia_longSingleContract : (asia_shortSetupActive and asia_shortSetupActive[1] == false) ? asia_shortSingleContract : (ny_longSetupActive and ny_longSetupActive[1] == false) ? ny_longSingleContract : (ny_shortSetupActive and ny_shortSetupActive[1] == false) ? ny_shortSingleContract : false

plot(currentTP1, "TP1", display=display.none)
plot(currentTP2, "TP2", display=display.none)
plot(currentStop, "StopLoss", display=display.none)
plot(currentBE, "BreakevenPrice", display=display.none)
plot(currentEntry, "Entry", display=display.none)
plot(currentQty, "Quantity", display=display.none)
plot(currentHalfQty, "HalfQuantity", display=display.none)
plot(setupEntry, "SetupEntry", display=display.none)
plot(setupStop, "SetupStop", display=display.none)
plot(setupTP1, "SetupTP1", display=display.none)
plot(setupTP2, "SetupTP2", display=display.none)

// ----------------------------------------------------------------------------------------
// Alert Conditions for TradersPost
// ----------------------------------------------------------------------------------------
// Entry signals - fire when setup becomes active (FVG detected)
longEntrySignal = ((asia_longSetupActive and asia_longSetupActive[1] == false) or (ny_longSetupActive and ny_longSetupActive[1] == false))
shortEntrySignal = ((asia_shortSetupActive and asia_shortSetupActive[1] == false) or (ny_shortSetupActive and ny_shortSetupActive[1] == false))

// TP1 hit - fire when BE becomes active (position still open)
tp1HitLong = (strategy.position_size > 0 and ((activeSession == "asia" and asia_longBEActive and not asia_longBEActive[1]) or (activeSession == "ny" and ny_longBEActive and not ny_longBEActive[1])))
tp1HitShort = (strategy.position_size < 0 and ((activeSession == "asia" and asia_shortBEActive and not asia_shortBEActive[1]) or (activeSession == "ny" and ny_shortBEActive and not ny_shortBEActive[1])))

if longEntrySignal
    if setupSingleContract
        alert('{"ticker": "MNQ", "action": "buy", "quantity": ' + str.tostring(currentQty) + ', "price": ' + str.tostring(setupEntry) + ', "takeProfit": {"limitPrice": ' + str.tostring(setupTP2) + '}, "stopLoss": {"type": "stop", "stopPrice": ' + str.tostring(setupStop) + '}}', alert.freq_once_per_bar_close)
    else
        // TP1 tranche (higher half)
        alert('{"ticker": "MNQ", "action": "buy", "quantity": ' + str.tostring(currentQty - setupHalfQty) + ', "price": ' + str.tostring(setupEntry) + ', "takeProfit": {"limitPrice": ' + str.tostring(setupTP1) + '}, "stopLoss": {"type": "stop", "stopPrice": ' + str.tostring(setupStop) + '}}', alert.freq_once_per_bar_close)
        // TP2 tranche (lower half, runner)
        alert('{"ticker": "MNQ", "action": "buy", "quantity": ' + str.tostring(setupHalfQty) + ', "price": ' + str.tostring(setupEntry) + ', "takeProfit": {"limitPrice": ' + str.tostring(setupTP2) + '}, "stopLoss": {"type": "stop", "stopPrice": ' + str.tostring(setupStop) + '}, "cancel": false}', alert.freq_once_per_bar_close)
if shortEntrySignal
    if setupSingleContract
        alert('{"ticker": "MNQ", "action": "sell", "quantity": ' + str.tostring(currentQty) + ', "price": ' + str.tostring(setupEntry) + ', "takeProfit": {"limitPrice": ' + str.tostring(setupTP2) + '}, "stopLoss": {"type": "stop", "stopPrice": ' + str.tostring(setupStop) + '}}', alert.freq_once_per_bar_close)
    else
        // TP1 tranche (higher half)
        alert('{"ticker": "MNQ", "action": "sell", "quantity": ' + str.tostring(currentQty - setupHalfQty) + ', "price": ' + str.tostring(setupEntry) + ', "takeProfit": {"limitPrice": ' + str.tostring(setupTP1) + '}, "stopLoss": {"type": "stop", "stopPrice": ' + str.tostring(setupStop) + '}}', alert.freq_once_per_bar_close)
        // TP2 tranche (lower half, runner)
        alert('{"ticker": "MNQ", "action": "sell", "quantity": ' + str.tostring(setupHalfQty) + ', "price": ' + str.tostring(setupEntry) + ', "takeProfit": {"limitPrice": ' + str.tostring(setupTP2) + '}, "stopLoss": {"type": "stop", "stopPrice": ' + str.tostring(setupStop) + '}, "cancel": false}', alert.freq_once_per_bar_close)
if tp1HitLong
    // Cancel existing bracket orders
    alert('{"ticker": "MNQ", "action": "cancel"}', alert.freq_once_per_bar_close)
    // Replace stop at breakeven (delayed to ensure cancel processes first)
    alert('{"ticker": "MNQ", "action": "sell", "orderType": "stop", "stopPrice": ' + str.tostring(currentBE) + ', "quantity": ' + str.tostring(currentHalfQty) + ', "sentiment": "flat", "cancel": false, "delay": 2}', alert.freq_once_per_bar_close)
    // Replace TP at TP2 (delayed further)
    alert('{"ticker": "MNQ", "action": "sell", "orderType": "limit", "limitPrice": ' + str.tostring(currentTP2) + ', "quantity": ' + str.tostring(currentHalfQty) + ', "sentiment": "flat", "cancel": false, "delay": 4}', alert.freq_once_per_bar_close)
if tp1HitShort
    // Cancel existing bracket orders
    alert('{"ticker": "MNQ", "action": "cancel"}', alert.freq_once_per_bar_close)
    // Replace stop at breakeven (delayed to ensure cancel processes first)
    alert('{"ticker": "MNQ", "action": "buy", "orderType": "stop", "stopPrice": ' + str.tostring(currentBE) + ', "quantity": ' + str.tostring(currentHalfQty) + ', "sentiment": "flat", "cancel": false, "delay": 2}', alert.freq_once_per_bar_close)
    // Replace TP at TP2 (delayed further)
    alert('{"ticker": "MNQ", "action": "buy", "orderType": "limit", "limitPrice": ' + str.tostring(currentTP2) + ', "quantity": ' + str.tostring(currentHalfQty) + ', "sentiment": "flat", "cancel": false, "delay": 4}', alert.freq_once_per_bar_close)

// ----------------------------------------------------------------------------------------
// Visuals - ORB Lines
// ----------------------------------------------------------------------------------------
// Asia ORB lines (blue) - show during Asia entry window
plotAsiaORB = inAsiaRTH and inAsiaEntryWin
plot(plotAsiaORB ? asia_orbHigh : na, "Asia ORB High", style=plot.style_linebr, linewidth=2, color=color.new(#2196F3, 0))
plot(plotAsiaORB ? asia_orbLow  : na, "Asia ORB Low",  style=plot.style_linebr, linewidth=2, color=color.new(#64B5F6, 0))

// NY ORB lines (green) - show during NY entry window
plotNyORB = inNyRTH and inNyEntryWin
plot(plotNyORB ? ny_orbHigh : na, "NY ORB High", style=plot.style_linebr, linewidth=2, color=color.new(#18b79c, 0))
plot(plotNyORB ? ny_orbLow  : na, "NY ORB Low",  style=plot.style_linebr, linewidth=2, color=color.new(#5d606b, 0))
